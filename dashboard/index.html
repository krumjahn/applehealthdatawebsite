<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Health Dashboard | Apple Health Data</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Charter:wght@400;700&display=swap');
        
        :root {
            --cream: #FDFCF8;
            --ink: #1A1A1A;
            --clinical-blue: #2C3E50;
            --clinical-red: #A93226;
        }

        body {
            font-family: 'Charter', 'Georgia', serif;
            background-color: var(--cream);
            color: var(--ink);
            line-height: 1.6;
        }

        .bento-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.5rem;
            padding: 1.5rem;
        }

        .bento-item {
            background: white;
            border: 1px solid #E5E1D8;
            border-radius: 8px;
            padding: 1.5rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.02);
            transition: transform 0.2s ease;
        }

        .bento-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
        }

        .badge {
            font-family: sans-serif;
            font-size: 0.75rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            border: 1px solid currentColor;
        }

        .delta-positive { color: #1E8449; }
        .delta-negative { color: #A93226; }
        
        h1, h2, h3 {
            font-weight: 700;
            letter-spacing: -0.02em;
        }

        .metric-value {
            font-size: 2.5rem;
            font-weight: 700;
            line-height: 1;
            margin: 0.5rem 0;
        }

        .metric-unit {
            font-size: 1rem;
            color: #666;
            font-weight: 400;
        }

        header {
            border-bottom: 2px solid var(--ink);
            margin-bottom: 2rem;
        }
    </style>
</head>
<body class="max-w-6xl mx-auto px-4 py-8">
    <header class="flex flex-col md:flex-row justify-between items-baseline pb-4 mb-8">
        <div>
            <h1 class="text-3xl md:text-4xl mb-2">Health Metrics Journal</h1>
            <p class="text-sm italic text-gray-600">Established 2025 â€¢ Local-First Persistence</p>
        </div>
        <div class="mt-4 md:mt-0 flex items-center gap-4">
            <a href="/pro" class="text-sm font-sans font-bold text-blue-600 hover:text-blue-800 flex items-center gap-2">
                <i data-lucide="shield-check" class="w-4 h-4"></i> Biohacker Pro
            </a>
            <div class="badge text-clinical-blue border-clinical-blue flex items-center gap-2">
                <i data-lucide="shield-check" class="w-3 h-3"></i>
                0 KB Sent to Cloud
            </div>
            <button id="refresh-btn" class="text-sm font-sans underline hover:text-gray-600">Refresh Data</button>
        </div>
    </header>

    <main>
        <div class="bento-grid">
            <!-- Steps Card -->
            <div class="bento-item md:col-span-2">
                <div class="flex justify-between items-start mb-4">
                    <div class="flex items-center gap-2 text-clinical-blue">
                        <i data-lucide="footprints" class="w-5 h-5"></i>
                        <h3 class="font-sans uppercase text-xs font-bold tracking-widest">Daily Steps</h3>
                    </div>
                </div>
                <div id="steps-metric" class="metric-value">0 <span class="metric-unit">steps</span></div>
                <div id="steps-delta" class="text-sm font-sans flex items-center gap-1">
                    <span class="delta-label">Weekly Average:</span>
                    <span class="delta-value">--</span>
                </div>
            </div>

            <!-- Heart Rate Card -->
            <div class="bento-item">
                <div class="flex justify-between items-start mb-4">
                    <div class="flex items-center gap-2 text-clinical-red">
                        <i data-lucide="heart" class="w-5 h-5"></i>
                        <h3 class="font-sans uppercase text-xs font-bold tracking-widest">Avg Heart Rate</h3>
                    </div>
                </div>
                <div id="hr-metric" class="metric-value">0 <span class="metric-unit">bpm</span></div>
                <div id="hr-delta" class="text-sm font-sans flex items-center gap-1">
                    <span class="delta-label">vs Prev Week:</span>
                    <span class="delta-value">--</span>
                </div>
            </div>

            <!-- Sleep Card -->
            <div class="bento-item">
                <div class="flex justify-between items-start mb-4">
                    <div class="flex items-center gap-2 text-indigo-900">
                        <i data-lucide="moon" class="w-5 h-5"></i>
                        <h3 class="font-sans uppercase text-xs font-bold tracking-widest">Sleep Duration</h3>
                    </div>
                </div>
                <div id="sleep-metric" class="metric-value">0 <span class="metric-unit">hrs</span></div>
                <div id="sleep-delta" class="text-sm font-sans flex items-center gap-1">
                    <span class="delta-label">Weekly Delta:</span>
                    <span class="delta-value">--</span>
                </div>
            </div>

            <!-- Empty State / Data Info -->
            <div id="empty-state" class="bento-item md:col-span-2 bg-gray-50 border-dashed text-center py-12 hidden">
                <i data-lucide="database-zap" class="w-12 h-12 text-gray-300 mx-auto mb-4"></i>
                <h3 class="text-xl mb-2">No Local Data Found</h3>
                <p class="text-sm text-gray-500 max-w-sm mx-auto mb-6">Import your <code>export.xml</code> using the Convert Tool to populate this dashboard.</p>
                <a href="../convert-tool/" class="font-sans font-bold text-clinical-blue underline">Go to Convert Tool</a>
            </div>
        </div>

        <section class="mt-12 px-6">
            <h2 class="text-2xl border-b border-gray-200 pb-2 mb-6">Technical Ledger</h2>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-8 text-sm italic text-gray-600">
                <div>
                    <h4 class="font-bold not-italic text-black mb-2 uppercase text-xs font-sans tracking-widest">Storage Protocol</h4>
                    <p>Metrics are committed to IndexedDB (Client-Side). No telemetry, no cookies, no external API calls.</p>
                </div>
                <div>
                    <h4 class="font-bold not-italic text-black mb-2 uppercase text-xs font-sans tracking-widest">Analysis Engine</h4>
                    <p>Delta calculations performed on-the-fly using temporal windowing of 7-day increments.</p>
                </div>
                <div>
                    <h4 class="font-bold not-italic text-black mb-2 uppercase text-xs font-sans tracking-widest">Data Integrity</h4>
                    <p>Records are derived from the official HealthKit XML specification via standard parser hooks.</p>
                </div>
            </div>
        </section>
    </main>

    <script>
        // IndexedDB Logic
        const DB_NAME = 'HealthDashboardDB';
        const DB_VERSION = 1;
        const STORE_NAME = 'metrics';

        function initDB() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open(DB_NAME, DB_VERSION);
                request.onerror = event => reject("Database error: " + event.target.errorCode);
                request.onupgradeneeded = event => {
                    const db = event.target.result;
                    if (!db.objectStoreNames.contains(STORE_NAME)) {
                        const store = db.createObjectStore(STORE_NAME, { keyPath: 'id', autoIncrement: true });
                        store.createIndex('type', 'type', { unique: false });
                        store.createIndex('date', 'date', { unique: false });
                    }
                };
                request.onsuccess = event => resolve(event.target.result);
            });
        }

        async function getMetrics() {
            const db = await initDB();
            return new Promise((resolve, reject) => {
                const transaction = db.transaction([STORE_NAME], 'readonly');
                const store = transaction.objectStore(STORE_NAME);
                const request = store.getAll();
                request.onsuccess = () => resolve(request.result);
                request.onerror = () => reject(request.error);
            });
        }

        // Dashboard Logic
        async function updateDashboard() {
            const data = await getMetrics();
            
            if (!data || data.length === 0) {
                document.getElementById('empty-state').classList.remove('hidden');
                return;
            } else {
                document.getElementById('empty-state').classList.add('hidden');
            }

            const now = new Date();
            const sevenDaysAgo = new Date(now.getTime() - (7 * 24 * 60 * 60 * 1000));
            const fourteenDaysAgo = new Date(now.getTime() - (14 * 24 * 60 * 60 * 1000));

            const filterByTypeAndDate = (type, start, end) => {
                return data.filter(d => {
                    const dDate = new Date(d.date);
                    return d.type.includes(type) && dDate >= start && dDate < end;
                });
            };

            const calculateAvg = (records) => {
                if (records.length === 0) return 0;
                const sum = records.reduce((acc, r) => acc + parseFloat(r.value || 0), 0);
                return sum / records.length;
            };

            const calculateSum = (records) => {
                return records.reduce((acc, r) => acc + parseFloat(r.value || 0), 0);
            };

            // Steps (Sum for current day, Avg for weeks)
            const currentSteps = filterByTypeAndDate('StepCount', new Date(now.setHours(0,0,0,0)), new Date(now.setHours(23,59,59,999)));
            const stepsVal = calculateSum(currentSteps);
            document.getElementById('steps-metric').innerHTML = `${stepsVal.toLocaleString()} <span class="metric-unit">steps</span>`;
            
            const stepsThisWeek = filterByTypeAndDate('StepCount', sevenDaysAgo, new Date());
            const stepsPrevWeek = filterByTypeAndDate('StepCount', fourteenDaysAgo, sevenDaysAgo);
            const stepsThisWeekAvg = calculateSum(stepsThisWeek) / 7;
            const stepsPrevWeekAvg = calculateSum(stepsPrevWeek) / 7;
            updateDelta('steps-delta', stepsThisWeekAvg, stepsPrevWeekAvg, 'steps/day');

            // Heart Rate
            const hrThisWeek = filterByTypeAndDate('HeartRate', sevenDaysAgo, new Date());
            const hrPrevWeek = filterByTypeAndDate('HeartRate', fourteenDaysAgo, sevenDaysAgo);
            const hrThisWeekAvg = calculateAvg(hrThisWeek);
            const hrPrevWeekAvg = calculateAvg(hrPrevWeek);
            document.getElementById('hr-metric').innerHTML = `${Math.round(hrThisWeekAvg)} <span class="metric-unit">bpm</span>`;
            updateDelta('hr-delta', hrThisWeekAvg, hrPrevWeekAvg, 'bpm', true);

            // Sleep
            const sleepThisWeek = filterByTypeAndDate('SleepAnalysis', sevenDaysAgo, new Date());
            const sleepPrevWeek = filterByTypeAndDate('SleepAnalysis', fourteenDaysAgo, sevenDaysAgo);
            const sleepThisWeekAvg = calculateSum(sleepThisWeek) / 7;
            const sleepPrevWeekAvg = calculateSum(sleepPrevWeek) / 7;
            document.getElementById('sleep-metric').innerHTML = `${(sleepThisWeekAvg).toFixed(1)} <span class="metric-unit">hrs</span>`;
            updateDelta('sleep-delta', sleepThisWeekAvg, sleepPrevWeekAvg, 'hrs');
        }

        function updateDelta(elementId, current, prev, unit, inverse = false) {
            const el = document.getElementById(elementId);
            const deltaVal = el.querySelector('.delta-value');
            if (prev === 0) {
                deltaVal.textContent = `Avg: ${Math.round(current)} ${unit}`;
                return;
            }
            const diff = current - prev;
            const percent = (diff / prev) * 100;
            const sign = diff >= 0 ? '+' : '';
            
            let colorClass = diff >= 0 ? 'delta-positive' : 'delta-negative';
            if (inverse) {
                colorClass = diff <= 0 ? 'delta-positive' : 'delta-negative';
            }

            deltaVal.innerHTML = `<span class="${colorClass}">${sign}${Math.round(percent)}%</span> vs prev week`;
        }

        document.getElementById('refresh-btn').addEventListener('click', updateDashboard);

        initDB().then(updateDashboard);
        lucide.createIcons();
    </script>
</body>
</html>
