<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Apple Health XML to CSV Converter</title>
    <meta name="description" content="A free, client-side tool to convert your Apple Health export.xml file into a clean, usable CSV format directly in your browser. Your data remains completely private.">
    <meta name="keywords" content="convert apple health xml, apple health xml to csv, health export.xml, convert healthkit xml, apple health parser, xml to csv tool">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&display=swap');
        body { font-family: 'Plus Jakarta Sans', sans-serif; background-color: #f8f8f8; color: #1f2937; }
        .accent-color { color: #f43f5e; } /* Rose-500 */
        .accent-bg { background-color: #f43f5e; }
        .accent-border { border-color: #f43f5e; }
        .drop-zone {
            border: 3px dashed #e5e7eb;
            transition: all 0.3s ease;
        }
        .drop-zone.dragover {
            border-color: #f43f5e;
            background-color: #fce7f3;
        }
    </style>
</head>
<body class="flex flex-col items-center justify-center min-h-screen p-4">

    <main class="w-full max-w-2xl text-center">
        <!-- Heart Icon -->
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-24 h-24 accent-color mx-auto mb-6">
          <path d="M11.645 20.91l-.007-.003-.022-.012a15.247 15.247 0 01-1.344-.688 15.247 15.247 0 01-1.344-.688c-.058-.033-.115-.066-.172-.1a14.947 14.947 0 01-4.71-3.635C3.41 12.564 3 11.233 3 9.75 3 7.004 5.004 5 7.75 5c1.554 0 2.944.86 3.603 2.184a.75.75 0 001.292 0C13.306 5.86 14.696 5 16.25 5 18.996 5 21 7.004 21 9.75c0 1.483-.41 2.814-1.144 4.022a14.947 14.947 0 01-4.71 3.635c-.058.033-.115.066-.172.1a15.247 15.247 0 01-2.688 1.376l-.022.012-.007.003z" />
        </svg>

        <h1 class="text-4xl md:text-5xl font-bold text-gray-900 mb-3">Apple Health XML to CSV Converter</h1>
        <p class="text-lg text-gray-600 mb-12">Convert your Apple Health export.xml to CSV format. Completely private!</p>
        
        <div id="drop-zone" class="drop-zone w-full p-8 md:p-16 rounded-2xl border-rose-500 border-4">
            <div class="flex flex-col items-center justify-center">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-16 h-16 accent-color mb-6">
                    <path fill-rule="evenodd" d="M12 1.5a5.25 5.25 0 00-5.25 5.25v3a3 3 0 00-3 3v6.75a3 3 0 003 3h10.5a3 3 0 003-3v-6.75a3 3 0 00-3-3v-3c0-2.9-2.35-5.25-5.25-5.25zm3.75 8.25v-3a3.75 3.75 0 10-7.5 0v3h7.5z" clip-rule="evenodd" />
                </svg>
                <label for="file-upload" class="cursor-pointer accent-border border-2 text-rose-500 font-semibold py-3 px-8 rounded-lg hover:accent-bg hover:text-white transition-all">
                    Load export.xml
                </label>
                <input type="file" id="file-upload" class="hidden" accept=".xml">
                <p id="status" class="text-gray-500 mt-4">... or drop your export.xml file here</p>
                <a id="download-link" class="hidden mt-6 bg-green-500 text-white font-bold py-3 px-8 rounded-lg hover:bg-green-600 transition-all">Download CSV</a>
            </div>
        </div>
    </main>

    <footer class="text-center mt-12">
        <p class="text-gray-500">All work is done locally by your browser. <strong>Nothing is uploaded to any server.</strong></p>
        <p class="text-sm text-gray-400 mt-1">If you are having issues please <a href="mailto:support@applehealthdata.com" class="underline">contact support</a>.</p>
    </footer>

    <script>
        const dropZone = document.getElementById('drop-zone');
        const fileInput = document.getElementById('file-upload');
        const statusDiv = document.getElementById('status');
        const downloadLink = document.getElementById('download-link');

        // Handle file selection via button
        fileInput.addEventListener('change', (event) => {
            const files = event.target.files;
            if (files.length > 0) {
                handleFile(files[0]);
            }
        });

        // Handle drag and drop
        dropZone.addEventListener('dragover', (event) => {
            event.preventDefault();
            dropZone.classList.add('dragover');
        });

        dropZone.addEventListener('dragleave', () => {
            dropZone.classList.remove('dragover');
        });

        dropZone.addEventListener('drop', (event) => {
            event.preventDefault();
            dropZone.classList.remove('dragover');
            const files = event.dataTransfer.files;
            if (files.length > 0) {
                handleFile(files[0]);
            }
        });
        
        // Make the dropzone clickable
        dropZone.addEventListener('click', () => {
            fileInput.click();
        });


        const handleFile = (file) => {
            if (!file || !file.name.endsWith('.xml')) {
                statusDiv.textContent = 'Please select a valid export.xml file.';
                return;
            }

            statusDiv.textContent = 'Reading file...';
            downloadLink.classList.add('hidden');

            const reader = new FileReader();

            reader.onload = (e) => {
                try {
                    statusDiv.textContent = 'Parsing XML... This may take a moment.';
                    const xmlString = e.target.result;
                    const parser = new DOMParser();
                    const xmlDoc = parser.parseFromString(xmlString, "application/xml");

                    if (xmlDoc.getElementsByTagName("parsererror").length) {
                        throw new Error("Failed to parse XML. Please ensure it's a valid export.xml file.");
                    }
                    
                    statusDiv.textContent = 'Converting to CSV...';

                    const records = xmlDoc.getElementsByTagName('Record');
                    let csvContent = 'type,sourceName,unit,startDate,endDate,value\n';
                    
                    for (let i = 0; i < records.length; i++) {
                        const record = records[i];
                        const type = record.getAttribute('type') || '';
                        const sourceName = record.getAttribute('sourceName') || '';
                        const unit = record.getAttribute('unit') || '';
                        const startDate = record.getAttribute('startDate') || '';
                        const endDate = record.getAttribute('endDate') || '';
                        const value = record.getAttribute('value') || '';

                        const escape = (str) => `"${(str || '').replace(/"/g, '""')}"`;

                        const row = [
                            escape(type),
                            escape(sourceName),
                            escape(unit),
                            escape(startDate),
                            escape(endDate),
                            escape(value)
                        ].join(',');
                        
                        csvContent += row + '\n';
                    }

                    if (records.length === 0) {
                        statusDiv.textContent = 'No records found. Is this a valid Apple Health export file?';
                        return;
                    }

                    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                    const url = URL.createObjectURL(blob);

                    downloadLink.href = url;
                    downloadLink.setAttribute('download', 'converted-health-data.csv');
                    downloadLink.classList.remove('hidden');
                    statusDiv.innerHTML = `Success! Converted ${records.length.toLocaleString()} records.`;

                } catch (error) {
                    statusDiv.textContent = `An error occurred: ${error.message}`;
                }
            };

            reader.onerror = () => {
                statusDiv.textContent = 'Error reading file.';
            };
            
            reader.readAsText(file);
        };
    </script>
</body>
</html>